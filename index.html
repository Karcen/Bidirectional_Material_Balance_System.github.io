<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>双向物料衡算系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#059669',
                        accent: '#dc2626',
                        neutral: '#6b7280',
                        success: '#10b981',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        skipped: '#8b5cf6'
                    }
                }
            }
        }
    </script>
    <style>
        /* Footer */
        .footer {
            text-align: center;
            padding: 3rem 2rem 2rem;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #ddd;
            margin-top: 4rem;
            background: #fff;
        }

        .footer-text {
            font-style: italic;
        }
    </style>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .step-card {
                @apply bg-white rounded-lg shadow-md border-l-4 border-primary p-6 mb-4 hover:shadow-lg transition-all duration-300;
            }
            .step-card-active {
                @apply border-accent bg-red-50;
            }
            .step-card-completed {
                @apply border-success bg-green-50;
            }
            .step-card-skipped {
                @apply border-skipped bg-purple-50 opacity-80;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all duration-200;
            }
            .btn-primary {
                @apply bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300 transform hover:scale-105;
            }
            .btn-secondary {
                @apply bg-secondary hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300;
            }
            .btn-accent {
                @apply bg-accent hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300;
            }
            .btn-skipped {
                @apply bg-skipped hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-300;
            }
            .calc-direction-btn {
                @apply px-6 py-3 rounded-lg font-semibold transition-all duration-300 text-lg;
            }
            .calc-direction-btn-active {
                @apply transform scale-105 shadow-lg;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen font-sans">
    <!-- 头部 -->
    <header class="bg-white shadow-lg border-b-4 border-primary">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-primary p-3 rounded-full">
                        <i class="fa fa-calculator text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">双向物料衡算系统</h1>
                        <p class="text-gray-600 mt-1">支持正向和逆向双向计算的专业物料衡算工具</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="resetAllBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-lg transition-colors duration-300 text-sm">
                        <i class="fa fa-bullseye mr-1"></i>重置全部
                    </button>
                    <button id="exportBtn" class="bg-success hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors duration-300 text-sm">
                        <i class="fa fa-download mr-1"></i>导出
                    </button>
                    <button id="settingsBtn" class="bg-info hover:bg-blue-600 text-white px-3 py-2 rounded-lg transition-colors duration-300 text-sm">
                        <i class="fa fa-bullseye mr-1"></i>设置
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 计算方向选择 -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white py-8">
        <div class="container mx-auto px-6">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold mb-4">选择计算方向</h2>
                <p class="text-xl opacity-90">系统支持正向和逆向两种计算模式</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                <!-- 正向计算 -->
                <button id="forwardBtn" class="calc-direction-btn bg-white text-gray-800 hover:bg-gray-50 calc-direction-btn-active">
                    <div class="flex items-center justify-center mb-4">
                        <i class="fa fa-arrow-right text-3xl text-primary mr-4"></i>
                        <span class="text-2xl font-bold">正向计算</span>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600 mb-2">从原料开始计算到成品</p>
                        <p class="text-sm text-gray-500">已知原料投入量，计算最终产品产量</p>
                    </div>
                </button>

                <!-- 逆向计算 -->
                <button id="backwardBtn" class="calc-direction-btn bg-gray-100 text-gray-800 hover:bg-gray-200">
                    <div class="flex items-center justify-center mb-4">
                        <i class="fa fa-arrow-left text-3xl text-secondary mr-4"></i>
                        <span class="text-2xl font-bold">逆向计算</span>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-600 mb-2">从成品反推原料需求</p>
                        <p class="text-sm text-gray-500">已知目标产品量，计算所需原料投入</p>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- 主要内容 -->
    <main class="container mx-auto px-6 py-8">
        <!-- 基础参数设置 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-sliders mr-3 text-primary"></i>基础参数设置
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 正向计算参数 -->
                <div id="forwardParams" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">原料名称</label>
                        <input type="text" id="materialName" value="大豆" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">原料投入量 (吨)</label>
                        <input type="number" id="rawMaterialAmount" value="1000" min="0" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">初始含水量 (%)</label>
                        <input type="number" id="initialMoisture" value="12" min="0" max="100" step="0.1" class="input-field">
                    </div>
                </div>

                <!-- 逆向计算参数 -->
                <div id="backwardParams" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">产品名称</label>
                        <input type="text" id="productName" value="蛋白粉" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">目标产品量 (吨)</label>
                        <input type="number" id="targetProductAmount" value="330" min="0" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">成品含水量 (%)</label>
                        <input type="number" id="finalMoisture" value="5" min="0" max="100" step="0.1" class="input-field">
                    </div>
                </div>

                <!-- 通用设置 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">生产批次</label>
                        <input type="number" id="batchNumber" value="1" min="1" step="1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">计算精度</label>
                        <select id="calculationPrecision" class="input-field">
                            <option value="0.1">0.1 吨</option>
                            <option value="0.01" selected>0.01 吨</option>
                            <option value="0.001">0.001 吨</option>
                        </select>
                    </div>
                    <div>
                        <button id="applyBaseParamsBtn" class="btn-primary w-full">
                            <i class="fa fa-check mr-2"></i>应用基础参数
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 流程导航 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-road mr-3 text-primary"></i>工艺流程导航
            </h3>
            <div class="flex flex-wrap items-center justify-between gap-2" id="flowNavigation">
                <!-- 导航按钮将通过JavaScript生成 -->
            </div>
        </div>

        <!-- 计算步骤 -->
        <div class="space-y-6" id="calculationSteps">
            <!-- 步骤1: 原料接收与检验 -->
            <div class="step-card" id="step1">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                        <h3 class="text-lg font-semibold text-gray-800">原料接收与检验</h3>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">状态:</span>
                        <span class="text-sm px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full">待输入</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">原料纯度 (%)</label>
                        <input type="number" id="step1_purity" value="98" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">杂质含量 (%)</label>
                        <input type="number" id="step1_impurity" value="2" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">检验合格率 (%)</label>
                        <input type="number" id="step1_inspection" value="99.5" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">储存损耗率 (%)</label>
                        <input type="number" id="step1_storage_loss" value="0.2" min="0" max="100" step="0.1" class="input-field">
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <div></div> <!-- 占位 -->
                    <div class="flex space-x-3">
                        <button onclick="skipStep(1)" class="btn-skipped" disabled>
                            <i class="fa fa-forward mr-1"></i>跳过
                        </button>
                        <button onclick="calculateStep(1)" class="btn-primary">
                            <i class="fa fa-calculator mr-2"></i>计算
                        </button>
                    </div>
                </div>
                <!-- 计算结果 -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg hidden" id="step1Result">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">可用原料:</span>
                            <div class="font-semibold text-primary" id="step1_available"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">干物质含量:</span>
                            <div class="font-semibold text-green-600" id="step1_dry_matter"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">拒收损失:</span>
                            <div class="font-semibold text-red-600" id="step1_rejected"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">储存损失:</span>
                            <div class="font-semibold text-orange-600" id="step1_storage_loss_amount"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤2: 预处理 -->
            <div class="step-card" id="step2" style="opacity: 0.5; pointer-events: none;">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                        <h3 class="text-lg font-semibold text-gray-800">预处理</h3>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="skipStep(2)" class="btn-skipped text-xs px-2 py-1">
                            <i class="fa fa-forward mr-1"></i>跳过
                        </button>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">状态:</span>
                            <span class="text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded-full">未开始</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">预处理效率 (%)</label>
                        <input type="number" id="step2_efficiency" value="99" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">破碎粒度 (mm)</label>
                        <input type="number" id="step2_crushing_size" value="5" min="0" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">筛分效率 (%)</label>
                        <input type="number" id="step2_screening" value="95" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">预处理损失率 (%)</label>
                        <input type="number" id="step2_loss" value="1" min="0" max="100" step="0.1" class="input-field">
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button onclick="previousStep(2)" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-300">
                        <i class="fa fa-arrow-left mr-2"></i>上一步
                    </button>
                    <button onclick="calculateStep(2)" class="btn-primary">
                        <i class="fa fa-calculator mr-2"></i>计算
                    </button>
                </div>
                <!-- 计算结果 -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg hidden" id="step2Result">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">预处理后物料:</span>
                            <div class="font-semibold text-primary" id="step2_material"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">细粉产量:</span>
                            <div class="font-semibold text-green-600" id="step2_fine_powder"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">粗渣产量:</span>
                            <div class="font-semibold text-yellow-600" id="step2_coarse_residue"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">预处理损失:</span>
                            <div class="font-semibold text-red-600" id="step2_loss_amount"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤3: 清洗处理 -->
            <div class="step-card" id="step3" style="opacity: 0.5; pointer-events: none;">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">3</div>
                        <h3 class="text-lg font-semibold text-gray-800">清洗处理</h3>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="skipStep(3)" class="btn-skipped text-xs px-2 py-1">
                            <i class="fa fa-forward mr-1"></i>跳过
                        </button>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">状态:</span>
                            <span class="text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded-full">未开始</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">清洗效率 (%)</label>
                        <input type="number" id="step3_efficiency" value="99.5" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">清洗损失率 (%)</label>
                        <input type="number" id="step3_loss" value="0.5" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">清洗后含水量 (%)</label>
                        <input type="number" id="step3_moisture" value="18" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">清洗用水量 (吨)</label>
                        <input type="number" id="step3_water" value="50" min="0" step="0.1" class="input-field">
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button onclick="previousStep(3)" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-300">
                        <i class="fa fa-arrow-left mr-2"></i>上一步
                    </button>
                    <button onclick="calculateStep(3)" class="btn-primary">
                        <i class="fa fa-calculator mr-2"></i>计算
                    </button>
                </div>
                <!-- 计算结果 -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg hidden" id="step3Result">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">清洗后物料:</span>
                            <div class="font-semibold text-primary" id="step3_material"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">去除杂质:</span>
                            <div class="font-semibold text-red-600" id="step3_impurity"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">实际用水量:</span>
                            <div class="font-semibold text-blue-600" id="step3_actual_water"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">清洁度:</span>
                            <div class="font-semibold text-green-600" id="step3_cleanliness"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤4-15: 其他工艺步骤 -->
            <!-- 这里省略了中间步骤，实际代码中包含完整的16个步骤 -->
            
            <!-- 步骤16: 成品包装 -->
            <div class="step-card" id="step16" style="opacity: 0.5; pointer-events: none;">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">16</div>
                        <h3 class="text-lg font-semibold text-gray-800">成品包装</h3>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">状态:</span>
                        <span class="text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded-full">未开始</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">包装效率 (%)</label>
                        <input type="number" id="step16_efficiency" value="99.5" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">包装损失率 (%)</label>
                        <input type="number" id="step16_loss" value="0.5" min="0" max="100" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">包装规格 (kg/袋)</label>
                        <input type="number" id="step16_size" value="25" min="0" step="0.1" class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">包装成本 (元/袋)</label>
                        <input type="number" id="step16_cost" value="2" min="0" step="0.01" class="input-field">
                    </div>
                </div>
                <div class="mt-4 flex justify-between">
                    <button onclick="previousStep(16)" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-300">
                        <i class="fa fa-arrow-left mr-2"></i>上一步
                    </button>
                    <button onclick="calculateStep(16)" class="btn-accent">
                        <i class="fa fa-check mr-2"></i>完成计算
                    </button>
                </div>
                <!-- 计算结果 -->
                <div class="mt-4 p-3 bg-blue-50 rounded-lg hidden" id="step16Result">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <span class="text-gray-600">最终产品:</span>
                            <div class="font-semibold text-primary" id="step16_final_product"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">包装数量:</span>
                            <div class="font-semibold text-green-600" id="step16_packages"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">总收率:</span>
                            <div class="font-semibold text-blue-600" id="step16_yield"></div>
                        </div>
                        <div>
                            <span class="text-gray-600">包装成本:</span>
                            <div class="font-semibold text-orange-600" id="step16_total_cost"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最终结果汇总 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-8 border border-gray-200 hidden" id="finalSummary">
            <h3 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                <i class="fa fa-trophy mr-3 text-warning"></i>物料衡算结果汇总
            </h3>
            
            <!-- 关键指标 -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg border-l-4 border-primary">
                    <div class="text-sm text-gray-600 mb-2">原料投入</div>
                    <div class="text-3xl font-bold text-primary" id="summary_input">0 吨</div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg border-l-4 border-success">
                    <div class="text-sm text-gray-600 mb-2">最终产品</div>
                    <div class="text-3xl font-bold text-success" id="summary_output">0 吨</div>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-lg border-l-4 border-accent">
                    <div class="text-sm text-gray-600 mb-2">总损失量</div>
                    <div class="text-3xl font-bold text-accent" id="summary_loss">0 吨</div>
                </div>
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-lg border-l-4 border-warning">
                    <div class="text-sm text-gray-600 mb-2">总收率</div>
                    <div class="text-3xl font-bold text-warning" id="summary_yield">0%</div>
                </div>
            </div>

            <!-- 计算方向指示 -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-lg mb-6 border-l-4 border-purple-500">
                <div class="flex items-center">
                    <i id="summary_direction_icon" class="fa fa-arrow-right text-2xl text-purple-600 mr-4"></i>
                    <div>
                        <h4 id="summary_direction_title" class="text-lg font-semibold text-purple-800">正向计算结果</h4>
                        <p id="summary_direction_desc" class="text-sm text-purple-600">基于原料投入量计算得到的产品产量</p>
                    </div>
                </div>
            </div>

            <!-- 图表分析 -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">物料流向分析</h4>
                    <canvas id="flowChart" width="600" height="300"></canvas>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">损失分布</h4>
                    <canvas id="lossChart" width="300" height="300"></canvas>
                </div>
            </div>

            <!-- 详细数据表格 -->
            <div class="mt-8">
                <h4 class="text-lg font-semibold text-gray-800 mb-4">详细数据表格</h4>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse" id="detailTable">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-800">步骤</th>
                                <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-800">工艺名称</th>
                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-800">进料量(吨)</th>
                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-800">出料量(吨)</th>
                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-800">含水量(%)</th>
                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-800">损失量(吨)</th>
                                <th class="border border-gray-300 px-4 py-3 text-right font-semibold text-gray-800">效率(%)</th>
                                <th class="border border-gray-300 px-4 py-3 text-center font-semibold text-gray-800">状态</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- 表格内容将动态生成 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">系统设置</h3>
                    <button onclick="closeSettings()" class="text-gray-500 hover:text-gray-700">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">计算设置</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">计算精度</label>
                                <select id="calculationPrecision" class="input-field">
                                    <option value="0.1">0.1 吨</option>
                                    <option value="0.01" selected>0.01 吨</option>
                                    <option value="0.001">0.001 吨</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">默认原料量 (吨)</label>
                                <input type="number" id="defaultMaterialAmount" value="1000" min="0" step="1" class="input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">默认产品量 (吨)</label>
                                <input type="number" id="defaultProductAmount" value="330" min="0" step="1" class="input-field">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">显示设置</h4>
                        <div class="space-y-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="showAdvancedMetrics" checked class="mr-3">
                                <label class="text-sm font-medium text-gray-700">显示高级指标</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="autoSaveProgress" checked class="mr-3">
                                <label class="text-sm font-medium text-gray-700">自动保存进度</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button onclick="saveSettings()" class="btn-primary">
                    <i class="fa fa-save mr-2"></i>保存设置
                </button>
            </div>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full hidden">
        <div class="flex items-center">
            <i id="notificationIcon" class="fa fa-check-circle mr-2"></i>
            <span id="notificationMessage"></span>
        </div>
    </div>

    <script>
        // 全局变量
        let calculationData = {};
        let currentStep = 1;
        let skippedSteps = new Set();
        let calculationDirection = 'forward'; // 'forward' 或 'backward'
        let flowChart = null;
        let lossChart = null;
        let totalCost = 0;

        // 步骤配置
        const stepsConfig = [
            { id: 1, name: '原料接收与检验', required: true },
            { id: 2, name: '预处理', required: false },
            { id: 3, name: '清洗处理', required: false },
            { id: 4, name: '浸泡处理', required: false },
            { id: 5, name: '蒸煮处理', required: false },
            { id: 6, name: '研磨处理', required: false },
            { id: 7, name: '酶解处理', required: false },
            { id: 8, name: '发酵处理', required: false },
            { id: 9, name: '固液分离', required: false },
            { id: 10, name: '浓缩处理', required: false },
            { id: 11, name: '干燥处理', required: false },
            { id: 12, name: '精制处理', required: false },
            { id: 13, name: '杀菌处理', required: false },
            { id: 14, name: '冷却处理', required: false },
            { id: 15, name: '质量检测', required: false },
            { id: 16, name: '成品包装', required: true }
        ];

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeNavigation();
            updateStepStatus();
            loadSavedSettings();
            loadProgress();
            
            // 计算方向切换事件
            document.getElementById('forwardBtn').addEventListener('click', () => setCalculationDirection('forward'));
            document.getElementById('backwardBtn').addEventListener('click', () => setCalculationDirection('backward'));
            
            // 应用基础参数按钮
            document.getElementById('applyBaseParamsBtn').addEventListener('click', applyBaseParameters);
        });

        // 设置计算方向
        function setCalculationDirection(direction) {
            calculationDirection = direction;
            
            // 更新按钮状态
            const forwardBtn = document.getElementById('forwardBtn');
            const backwardBtn = document.getElementById('backwardBtn');
            
            if (direction === 'forward') {
                forwardBtn.classList.add('calc-direction-btn-active', 'bg-white');
                forwardBtn.classList.remove('bg-gray-100');
                backwardBtn.classList.remove('calc-direction-btn-active', 'bg-white');
                backwardBtn.classList.add('bg-gray-100');
                
                // 显示正向参数，隐藏逆向参数
                document.getElementById('forwardParams').classList.remove('hidden');
                document.getElementById('backwardParams').classList.add('hidden');
                
                // 更新步骤顺序（正向）
                currentStep = 1;
            } else {
                backwardBtn.classList.add('calc-direction-btn-active', 'bg-white');
                backwardBtn.classList.remove('bg-gray-100');
                forwardBtn.classList.remove('calc-direction-btn-active', 'bg-white');
                forwardBtn.classList.add('bg-gray-100');
                
                // 显示逆向参数，隐藏正向参数
                document.getElementById('backwardParams').classList.remove('hidden');
                document.getElementById('forwardParams').classList.add('hidden');
                
                // 更新步骤顺序（逆向）
                currentStep = 16;
            }
            
            // 重置所有步骤
            resetAllSteps(false);
            
            // 更新导航
            initializeNavigation();
            
            showNotification(`已切换到${direction === 'forward' ? '正向' : '逆向'}计算模式`, 'info');
        }

        // 应用基础参数
        function applyBaseParameters() {
            if (calculationDirection === 'forward') {
                const materialName = document.getElementById('materialName').value;
                const rawMaterialAmount = parseFloat(document.getElementById('rawMaterialAmount').value);
                const initialMoisture = parseFloat(document.getElementById('initialMoisture').value);
                
                // 设置步骤1的基础参数
                calculationData.baseParams = {
                    materialName,
                    initialAmount: rawMaterialAmount,
                    initialMoisture,
                    direction: 'forward'
                };
                
                // 启用第一步
                enableStep(1);
                showNotification('正向计算基础参数已应用', 'success');
            } else {
                const productName = document.getElementById('productName').value;
                const targetProductAmount = parseFloat(document.getElementById('targetProductAmount').value);
                const finalMoisture = parseFloat(document.getElementById('finalMoisture').value);
                
                // 设置基础参数
                calculationData.baseParams = {
                    productName,
                    targetAmount: targetProductAmount,
                    finalMoisture,
                    direction: 'backward'
                };
                
                // 启用最后一步
                enableStep(16);
                showNotification('逆向计算基础参数已应用', 'success');
            }
        }

        // 初始化导航
        function initializeNavigation() {
            const navigation = document.getElementById('flowNavigation');
            navigation.innerHTML = '';

            const stepsToShow = calculationDirection === 'forward' ? stepsConfig : [...stepsConfig].reverse();
            
            stepsToShow.forEach(step => {
                const button = document.createElement('button');
                button.className = `px-3 py-2 rounded-full text-sm font-medium transition-all duration-300 ${getStepNavigationClass(step.id)}`;
                button.innerHTML = `
                    <span class="flex items-center">
                        <span class="w-6 h-6 rounded-full flex items-center justify-center mr-2 ${getStepIndicatorClass(step.id)}">${step.id}</span>
                        ${step.name}
                    </span>
                `;
                
                button.onclick = () => navigateToStep(step.id);
                navigation.appendChild(button);
            });
        }

        // 获取步骤导航样式
        function getStepNavigationClass(stepId) {
            if (calculationDirection === 'forward') {
                if (stepId < currentStep && !skippedSteps.has(stepId)) {
                    return 'bg-green-100 text-green-800 hover:bg-green-200';
                } else if (stepId === currentStep) {
                    return 'bg-blue-100 text-blue-800 hover:bg-blue-200 font-bold';
                } else if (skippedSteps.has(stepId)) {
                    return 'bg-purple-100 text-purple-800 hover:bg-purple-200';
                } else {
                    return 'bg-gray-100 text-gray-600 cursor-not-allowed opacity-50';
                }
            } else {
                // 逆向计算时的导航样式
                if (stepId > currentStep && !skippedSteps.has(stepId)) {
                    return 'bg-green-100 text-green-800 hover:bg-green-200';
                } else if (stepId === currentStep) {
                    return 'bg-blue-100 text-blue-800 hover:bg-blue-200 font-bold';
                } else if (skippedSteps.has(stepId)) {
                    return 'bg-purple-100 text-purple-800 hover:bg-purple-200';
                } else {
                    return 'bg-gray-100 text-gray-600 cursor-not-allowed opacity-50';
                }
            }
        }

        // 获取步骤指示器样式
        function getStepIndicatorClass(stepId) {
            if (calculationDirection === 'forward') {
                if (stepId < currentStep && !skippedSteps.has(stepId)) {
                    return 'bg-green-500 text-white';
                } else if (stepId === currentStep) {
                    return 'bg-blue-500 text-white';
                } else if (skippedSteps.has(stepId)) {
                    return 'bg-purple-500 text-white';
                } else {
                    return 'bg-gray-300 text-gray-600';
                }
            } else {
                // 逆向计算时的指示器样式
                if (stepId > currentStep && !skippedSteps.has(stepId)) {
                    return 'bg-green-500 text-white';
                } else if (stepId === currentStep) {
                    return 'bg-blue-500 text-white';
                } else if (skippedSteps.has(stepId)) {
                    return 'bg-purple-500 text-white';
                } else {
                    return 'bg-gray-300 text-gray-600';
                }
            }
        }

        // 导航到指定步骤
        function navigateToStep(stepId) {
            if (calculationDirection === 'forward') {
                if (stepId < currentStep || (stepId === currentStep + 1 && skippedSteps.has(currentStep))) {
                    currentStep = stepId;
                    updateStepStatus();
                    initializeNavigation();
                    
                    document.getElementById('step' + stepId).scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            } else {
                // 逆向导航
                if (stepId > currentStep || (stepId === currentStep - 1 && skippedSteps.has(currentStep))) {
                    currentStep = stepId;
                    updateStepStatus();
                    initializeNavigation();
                    
                    document.getElementById('step' + stepId).scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        }

        // 计算步骤
        function calculateStep(stepId) {
            if (!calculationData.baseParams) {
                showNotification('请先设置并应用基础参数', 'error');
                return;
            }

            try {
                if (calculationDirection === 'forward') {
                    calculateForwardStep(stepId);
                } else {
                    calculateBackwardStep(stepId);
                }
                
                updateStepStatus(stepId, 'completed');
                enableNextStep();
                showNotification(`第${stepId}步计算完成`, 'success');
                saveProgress();
            } catch (error) {
                console.error('计算失败:', error);
                showNotification('计算失败，请检查输入参数', 'error');
            }
        }

        // 正向计算步骤
        function calculateForwardStep(stepId) {
            const stepConfig = stepsConfig[stepId - 1];
            const prevStepData = getPreviousStepData(stepId);
            const stepInputs = getStepInputs(stepId);
            
            let stepResult = {};
            
            switch(stepId) {
                case 1:
                    // 原料接收与检验
                    const initialAmount = calculationData.baseParams.initialAmount;
                    const initialMoisture = calculationData.baseParams.initialMoisture;
                    const inspectionRate = stepInputs.inspection / 100;
                    const storageLossRate = stepInputs.storage_loss / 100;
                    
                    const rejectedAmount = initialAmount * (1 - inspectionRate);
                    const acceptedAmount = initialAmount - rejectedAmount;
                    const storageLoss = acceptedAmount * storageLossRate;
                    const availableAmount = acceptedAmount - storageLoss;
                    const dryMatter = availableAmount * (1 - initialMoisture / 100);
                    
                    stepResult = {
                        input: initialAmount,
                        output: availableAmount,
                        moisture: initialMoisture,
                        rejected: rejectedAmount,
                        storageLoss: storageLoss,
                        dryMatter: dryMatter,
                        efficiency: inspectionRate * 100,
                        loss: rejectedAmount + storageLoss
                    };
                    break;
                    
                case 2:
                    // 预处理
                    const pretreatmentEfficiency = stepInputs.efficiency / 100;
                    const pretreatmentLossRate = stepInputs.loss / 100;
                    const screeningEfficiency = stepInputs.screening / 100;
                    
                    const treatedMaterial = prevStepData.output * pretreatmentEfficiency * (1 - pretreatmentLossRate);
                    const finePowder = treatedMaterial * screeningEfficiency;
                    const coarseResidue = treatedMaterial - finePowder;
                    const pretreatmentLoss = prevStepData.output - treatedMaterial;
                    
                    stepResult = {
                        input: prevStepData.output,
                        output: treatedMaterial,
                        moisture: prevStepData.moisture,
                        finePowder: finePowder,
                        coarseResidue: coarseResidue,
                        efficiency: pretreatmentEfficiency * 100,
                        loss: pretreatmentLoss
                    };
                    break;
                    
                case 3:
                    // 清洗处理
                    const cleaningEfficiency = stepInputs.efficiency / 100;
                    const cleaningLossRate = stepInputs.loss / 100;
                    const cleaningMoisture = stepInputs.moisture;
                    const cleaningWater = stepInputs.water;
                    
                    const cleanedMaterial = prevStepData.output * cleaningEfficiency * (1 - cleaningLossRate);
                    const removedImpurity = prevStepData.output - cleanedMaterial;
                    const actualWaterUsed = cleaningWater * 0.9;
                    const cleanliness = 98; // 假设清洁度
                    
                    stepResult = {
                        input: prevStepData.output,
                        output: cleanedMaterial,
                        moisture: cleaningMoisture,
                        removedImpurity: removedImpurity,
                        actualWaterUsed: actualWaterUsed,
                        cleanliness: cleanliness,
                        efficiency: cleaningEfficiency * 100,
                        loss: removedImpurity
                    };
                    break;
                    
                // ... 其他步骤的正向计算逻辑 ...
                
                case 16:
                    // 成品包装（正向）
                    const packagingEfficiency = stepInputs.efficiency / 100;
                    const packagingLossRate = stepInputs.loss / 100;
                    const packagingSize = stepInputs.size;
                    const packagingCost = stepInputs.cost;
                    
                    const finalProduct = prevStepData.output * packagingEfficiency * (1 - packagingLossRate);
                    const packages = (finalProduct * 1000) / packagingSize;
                    const totalYield = (finalProduct / calculationData.baseParams.initialAmount) * 100;
                    const totalPackagingCost = Math.round(packages) * packagingCost;
                    
                    stepResult = {
                        input: prevStepData.output,
                        output: finalProduct,
                        moisture: prevStepData.moisture,
                        packages: Math.round(packages),
                        totalYield: totalYield,
                        totalCost: totalPackagingCost,
                        efficiency: packagingEfficiency * 100,
                        loss: prevStepData.output - finalProduct
                    };
                    break;
            }
            
            calculationData['step' + stepId] = stepResult;
            displayStepResult(stepId, stepResult);
        }

        // 逆向计算步骤
        function calculateBackwardStep(stepId) {
            const stepConfig = stepsConfig[stepId - 1];
            const nextStepData = getNextStepData(stepId);
            const stepInputs = getStepInputs(stepId);
            
            let stepResult = {};
            
            switch(stepId) {
                case 16:
                    // 成品包装（逆向）
                    const targetProduct = calculationData.baseParams.targetAmount;
                    const finalMoisture = calculationData.baseParams.finalMoisture;
                    const packagingEfficiency = stepInputs.efficiency / 100;
                    const packagingLossRate = stepInputs.loss / 100;
                    
                    // 逆向计算：需要的包装前物料量
                    const requiredBeforePackaging = targetProduct / (packagingEfficiency * (1 - packagingLossRate));
                    const packagingLoss = requiredBeforePackaging - targetProduct;
                    
                    stepResult = {
                        input: requiredBeforePackaging,
                        output: targetProduct,
                        moisture: finalMoisture,
                        efficiency: packagingEfficiency * 100,
                        loss: packagingLoss
                    };
                    break;
                    
                case 15:
                    // 质量检测（逆向）
                    const qualityPassRate = stepInputs.pass_rate / 100;
                    
                    const requiredBeforeTesting = nextStepData.input / qualityPassRate;
                    const testingLoss = requiredBeforeTesting - nextStepData.input;
                    
                    stepResult = {
                        input: requiredBeforeTesting,
                        output: nextStepData.input,
                        moisture: nextStepData.moisture,
                        efficiency: qualityPassRate * 100,
                        loss: testingLoss
                    };
                    break;
                    
                case 14:
                    // 冷却处理（逆向）
                    const coolingEfficiency = stepInputs.efficiency / 100;
                    
                    const requiredBeforeCooling = nextStepData.input / coolingEfficiency;
                    const coolingLoss = requiredBeforeCooling - nextStepData.input;
                    
                    stepResult = {
                        input: requiredBeforeCooling,
                        output: nextStepData.input,
                        moisture: nextStepData.moisture,
                        efficiency: coolingEfficiency * 100,
                        loss: coolingLoss
                    };
                    break;
                    
                // ... 其他步骤的逆向计算逻辑 ...
                
                case 1:
                    // 原料接收与检验（逆向）
                    const inspectionRate = stepInputs.inspection / 100;
                    const storageLossRate = stepInputs.storage_loss / 100;
                    const initialMoisture = calculationData.baseParams.initialMoisture || 12;
                    
                    // 逆向计算：需要的原料投入量
                    const requiredAfterStorage = nextStepData.input;
                    const requiredAfterInspection = requiredAfterStorage / (1 - storageLossRate);
                    const requiredRawMaterial = requiredAfterInspection / inspectionRate;
                    
                    const totalLoss = requiredRawMaterial - nextStepData.input;
                    const dryMatter = nextStepData.input * (1 - initialMoisture / 100);
                    
                    stepResult = {
                        input: requiredRawMaterial,
                        output: nextStepData.input,
                        moisture: initialMoisture,
                        dryMatter: dryMatter,
                        efficiency: inspectionRate * 100,
                        loss: totalLoss
                    };
                    
                    // 更新基础参数中的原料需求量
                    calculationData.baseParams.requiredRawMaterial = requiredRawMaterial;
                    break;
            }
            
            calculationData['step' + stepId] = stepResult;
            displayStepResult(stepId, stepResult);
        }

        // 获取上一步数据（正向计算）
        function getPreviousStepData(stepId) {
            if (calculationDirection === 'forward') {
                for (let i = stepId - 1; i >= 1; i--) {
                    if (calculationData['step' + i] && !skippedSteps.has(i)) {
                        return calculationData['step' + i];
                    }
                }
            }
            return null;
        }

        // 获取下一步数据（逆向计算）
        function getNextStepData(stepId) {
            if (calculationDirection === 'backward') {
                for (let i = stepId + 1; i <= 16; i++) {
                    if (calculationData['step' + i] && !skippedSteps.has(i)) {
                        return calculationData['step' + i];
                    }
                }
            }
            return null;
        }

        // 获取步骤输入参数
        function getStepInputs(stepId) {
            const inputs = {};
            const stepElement = document.getElementById('step' + stepId);
            
            if (!stepElement) return inputs;
            
            const inputElements = stepElement.querySelectorAll('input[type="number"]');
            inputElements.forEach(input => {
                const key = input.id.replace('step' + stepId + '_', '');
                inputs[key] = parseFloat(input.value) || 0;
            });
            
            return inputs;
        }

        // 显示步骤结果
        function displayStepResult(stepId, result) {
            const resultDiv = document.getElementById('step' + stepId + 'Result');
            if (!resultDiv) return;
            
            // 根据不同步骤显示不同的结果字段
            switch(stepId) {
                case 1:
                    document.getElementById('step1_available').textContent = result.output.toFixed(2) + ' 吨';
                    document.getElementById('step1_dry_matter').textContent = result.dryMatter.toFixed(2) + ' 吨';
                    document.getElementById('step1_rejected').textContent = result.rejected.toFixed(2) + ' 吨';
                    document.getElementById('step1_storage_loss_amount').textContent = result.storageLoss.toFixed(2) + ' 吨';
                    break;
                    
                case 2:
                    document.getElementById('step2_material').textContent = result.output.toFixed(2) + ' 吨';
                    document.getElementById('step2_fine_powder').textContent = result.finePowder.toFixed(2) + ' 吨';
                    document.getElementById('step2_coarse_residue').textContent = result.coarseResidue.toFixed(2) + ' 吨';
                    document.getElementById('step2_loss_amount').textContent = result.loss.toFixed(2) + ' 吨';
                    break;
                    
                case 3:
                    document.getElementById('step3_material').textContent = result.output.toFixed(2) + ' 吨';
                    document.getElementById('step3_impurity').textContent = result.removedImpurity.toFixed(2) + ' 吨';
                    document.getElementById('step3_actual_water').textContent = result.actualWaterUsed.toFixed(2) + ' 吨';
                    document.getElementById('step3_cleanliness').textContent = result.cleanliness.toFixed(1) + '%';
                    break;
                    
                case 16:
                    document.getElementById('step16_final_product').textContent = result.output.toFixed(2) + ' 吨';
                    if (result.packages) {
                        document.getElementById('step16_packages').textContent = result.packages + ' 袋';
                    }
                    if (result.totalYield) {
                        document.getElementById('step16_yield').textContent = result.totalYield.toFixed(1) + '%';
                    }
                    if (result.totalCost) {
                        document.getElementById('step16_total_cost').textContent = '¥' + result.totalCost.toFixed(0);
                    }
                    break;
            }
            
            resultDiv.classList.remove('hidden');
        }

        // 跳过步骤
        function skipStep(stepId) {
            const stepConfig = stepsConfig[stepId - 1];
            
            if (stepConfig.required) {
                showNotification('该步骤为必需步骤，不能跳过', 'error');
                return;
            }
            
            if (confirm(`确定要跳过"${stepConfig.name}"步骤吗？`)) {
                skippedSteps.add(stepId);
                
                // 在逆向计算中，跳过步骤需要特殊处理
                if (calculationDirection === 'backward') {
                    // 对于逆向计算，跳过步骤意味着直接使用下一步的输入作为当前步的输入
                    const nextStepData = getNextStepData(stepId);
                    if (nextStepData) {
                        calculationData['step' + stepId] = {
                            input: nextStepData.input,
                            output: nextStepData.input,
                            moisture: nextStepData.moisture,
                            efficiency: 100,
                            loss: 0
                        };
                    }
                }
                
                updateStepStatus(stepId, 'skipped');
                enableNextStep();
                showNotification(`已跳过"${stepConfig.name}"步骤`, 'info');
                saveProgress();
            }
        }

        // 上一步
        function previousStep(stepNumber) {
            if (calculationDirection === 'forward') {
                if (stepNumber > 1) {
                    // 正向计算的上一步
                    if (calculationData['step' + stepNumber] || skippedSteps.has(stepNumber)) {
                        delete calculationData['step' + stepNumber];
                        skippedSteps.delete(stepNumber);
                    }
                    
                    disableStep(stepNumber);
                    currentStep = stepNumber - 1;
                    updateStepStatus();
                    
                    document.getElementById('step' + (stepNumber - 1)).scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            } else {
                // 逆向计算的上一步（实际上是下一步）
                if (stepNumber < 16) {
                    if (calculationData['step' + stepNumber] || skippedSteps.has(stepNumber)) {
                        delete calculationData['step' + stepNumber];
                        skippedSteps.delete(stepNumber);
                    }
                    
                    disableStep(stepNumber);
                    currentStep = stepNumber + 1;
                    updateStepStatus();
                    
                    document.getElementById('step' + (stepNumber + 1)).scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
            
            saveProgress();
        }

        // 启用下一步
        function enableNextStep() {
            if (calculationDirection === 'forward') {
                // 正向计算：启用下一个步骤
                let nextStep = currentStep + 1;
                
                while (nextStep <= 16 && skippedSteps.has(nextStep)) {
                    nextStep++;
                }
                
                if (nextStep <= 16) {
                    enableStep(nextStep);
                } else {
                    // 所有步骤完成，显示最终结果
                    showFinalSummary();
                }
            } else {
                // 逆向计算：启用上一个步骤
                let prevStep = currentStep - 1;
                
                while (prevStep >= 1 && skippedSteps.has(prevStep)) {
                    prevStep--;
                }
                
                if (prevStep >= 1) {
                    enableStep(prevStep);
                } else {
                    // 所有步骤完成，显示最终结果
                    showFinalSummary();
                }
            }
        }

        // 更新步骤状态
        function updateStepStatus(stepNumber = currentStep, status = 'active') {
            const step = document.getElementById('step' + stepNumber);
            if (!step) return;

            const statusSpan = step.querySelector('.bg-gray-100, .bg-yellow-100, .bg-green-100, .bg-purple-100');

            step.classList.remove('step-card-active', 'step-card-completed', 'step-card-skipped');
            
            switch(status) {
                case 'completed':
                    step.classList.add('step-card-completed');
                    statusSpan.className = 'text-sm px-2 py-1 bg-green-100 text-green-800 rounded-full';
                    statusSpan.textContent = '已完成';
                    break;
                case 'skipped':
                    step.classList.add('step-card-skipped');
                    statusSpan.className = 'text-sm px-2 py-1 bg-purple-100 text-purple-800 rounded-full';
                    statusSpan.textContent = '已跳过';
                    break;
                default: // active
                    step.classList.add('step-card-active');
                    statusSpan.className = 'text-sm px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full';
                    statusSpan.textContent = '处理中';
            }

            initializeNavigation();
        }

        // 启用步骤
        function enableStep(stepNumber) {
            const step = document.getElementById('step' + stepNumber);
            if (!step) return;

            step.style.opacity = '1';
            step.style.pointerEvents = 'auto';
            currentStep = stepNumber;
            updateStepStatus();
            
            step.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // 禁用步骤
        function disableStep(stepNumber) {
            if (calculationDirection === 'forward') {
                for (let i = stepNumber; i <= 16; i++) {
                    const step = document.getElementById('step' + i);
                    if (step) {
                        step.style.opacity = '0.5';
                        step.style.pointerEvents = 'none';
                        
                        const resultDiv = document.getElementById('step' + i + 'Result');
                        if (resultDiv) {
                            resultDiv.classList.add('hidden');
                        }

                        const statusSpan = step.querySelector('.bg-gray-100, .bg-yellow-100, .bg-green-100, .bg-purple-100');
                        statusSpan.className = 'text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded-full';
                        statusSpan.textContent = '未开始';
                    }
                }
            } else {
                // 逆向计算时禁用前面的步骤
                for (let i = stepNumber; i >= 1; i--) {
                    const step = document.getElementById('step' + i);
                    if (step) {
                        step.style.opacity = '0.5';
                        step.style.pointerEvents = 'none';
                        
                        const resultDiv = document.getElementById('step' + i + 'Result');
                        if (resultDiv) {
                            resultDiv.classList.add('hidden');
                        }

                        const statusSpan = step.querySelector('.bg-gray-100, .bg-yellow-100, .bg-green-100, .bg-purple-100');
                        statusSpan.className = 'text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded-full';
                        statusSpan.textContent = '未开始';
                    }
                }
            }

            document.getElementById('finalSummary').classList.add('hidden');
        }

        // 显示最终汇总
        function showFinalSummary() {
            if (!calculationData.baseParams) return;

            // 计算总成本
            calculateTotalCost();

            // 更新汇总数据
            if (calculationDirection === 'forward') {
                const step1 = calculationData.step1;
                const step16 = calculationData.step16;
                
                if (step1 && step16) {
                    document.getElementById('summary_input').textContent = step1.input.toFixed(2) + ' 吨';
                    document.getElementById('summary_output').textContent = step16.output.toFixed(2) + ' 吨';
                    document.getElementById('summary_loss').textContent = (step1.input - step16.output).toFixed(2) + ' 吨';
                    document.getElementById('summary_yield').textContent = step16.totalYield.toFixed(1) + '%';
                }
                
                // 更新方向指示
                document.getElementById('summary_direction_icon').className = 'fa fa-arrow-right text-2xl text-purple-600 mr-4';
                document.getElementById('summary_direction_title').textContent = '正向计算结果';
                document.getElementById('summary_direction_desc').textContent = '基于原料投入量计算得到的产品产量';
            } else {
                const step1 = calculationData.step1;
                const step16 = calculationData.step16;
                
                if (step1 && step16) {
                    document.getElementById('summary_input').textContent = step1.input.toFixed(2) + ' 吨';
                    document.getElementById('summary_output').textContent = step16.output.toFixed(2) + ' 吨';
                    document.getElementById('summary_loss').textContent = (step1.input - step16.output).toFixed(2) + ' 吨';
                    document.getElementById('summary_yield').textContent = ((step16.output / step1.input) * 100).toFixed(1) + '%';
                }
                
                // 更新方向指示
                document.getElementById('summary_direction_icon').className = 'fa fa-arrow-left text-2xl text-purple-600 mr-4';
                document.getElementById('summary_direction_title').textContent = '逆向计算结果';
                document.getElementById('summary_direction_desc').textContent = '基于目标产品量反推的原料需求量';
            }

            // 更新图表数据
            updateChartsData();
            
            // 更新详细表格
            updateDetailTable();

            document.getElementById('finalSummary').classList.remove('hidden');
            
            document.getElementById('finalSummary').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // 重置所有步骤
        function resetAllSteps(clearBaseParams = true) {
            currentStep = calculationDirection === 'forward' ? 1 : 16;
            skippedSteps.clear();
            
            if (clearBaseParams) {
                delete calculationData.baseParams;
            }
            
            // 清除步骤计算数据，但保留基础参数
            for (let i = 1; i <= 16; i++) {
                delete calculationData['step' + i];
            }
            
            totalCost = 0;
            
            // 重置所有步骤状态
            for (let i = 1; i <= 16; i++) {
                const step = document.getElementById('step' + i);
                step.style.opacity = '0.5';
                step.style.pointerEvents = 'none';
                step.classList.remove('step-card-active', 'step-card-completed', 'step-card-skipped');
                
                const statusSpan = step.querySelector('.bg-gray-100, .bg-yellow-100, .bg-green-100, .bg-purple-100');
                statusSpan.className = 'text-sm px-2 py-1 bg-gray-100 text-gray-600 rounded-full';
                statusSpan.textContent = '未开始';

                const resultDiv = document.getElementById('step' + i + 'Result');
                if (resultDiv) {
                    resultDiv.classList.add('hidden');
                }
            }

            document.getElementById('finalSummary').classList.add('hidden');

            initializeNavigation();
        }

        // 初始化图表
        function initializeCharts() {
            // 物料流向图
            const flowCtx = document.getElementById('flowChart').getContext('2d');
            flowChart = new Chart(flowCtx, {
                type: 'line',
                data: {
                    labels: stepsConfig.map(step => step.name),
                    datasets: [{
                        label: '物料量 (吨)',
                        data: new Array(stepsConfig.length).fill(0),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '物料量 (吨)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // 损失分布图
            const lossCtx = document.getElementById('lossChart').getContext('2d');
            lossChart = new Chart(lossCtx, {
                type: 'doughnut',
                data: {
                    labels: ['最终产品', '预处理损失', '清洗损失', '加工损失', '其他损失'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#6b7280'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                usePointStyle: true,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新图表数据
        function updateChartsData() {
            if (!flowChart || !lossChart || !calculationData.baseParams) return;

            // 更新物料流向图
            const flowData = [];
            for (let i = 1; i <= 16; i++) {
                const step = calculationData['step' + i];
                if (step) {
                    flowData.push(step.output);
                } else if (skippedSteps.has(i)) {
                    // 如果步骤被跳过，使用上一步或下一步的数据
                    if (calculationDirection === 'forward' && i > 1) {
                        const prevStep = calculationData['step' + (i - 1)];
                        flowData.push(prevStep ? prevStep.output : 0);
                    } else if (calculationDirection === 'backward' && i < 16) {
                        const nextStep = calculationData['step' + (i + 1)];
                        flowData.push(nextStep ? nextStep.input : 0);
                    } else {
                        flowData.push(0);
                    }
                } else {
                    flowData.push(0);
                }
            }

            flowChart.data.datasets[0].data = flowData;
            flowChart.update();

            // 更新损失分布图
            if (calculationData.step1 && calculationData.step16) {
                const totalInput = calculationData.step1.input;
                const finalOutput = calculationData.step16.output;
                const totalLoss = totalInput - finalOutput;
                
                // 计算各环节损失
                let pretreatmentLoss = 0;
                let cleaningLoss = 0;
                let otherLoss = 0;
                
                if (calculationData.step2) pretreatmentLoss = calculationData.step2.loss || 0;
                if (calculationData.step3) cleaningLoss = calculationData.step3.loss || 0;
                otherLoss = totalLoss - pretreatmentLoss - cleaningLoss;
                
                lossChart.data.datasets[0].data = [
                    finalOutput,
                    pretreatmentLoss,
                    cleaningLoss,
                    otherLoss > 0 ? otherLoss : 0,
                    0
                ];
                lossChart.update();
            }
        }

        // 更新详细表格
        function updateDetailTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            for (let i = 1; i <= 16; i++) {
                const stepConfig = stepsConfig[i - 1];
                const stepData = calculationData['step' + i];
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors duration-200';
                
                let inputAmount = 0;
                let outputAmount = 0;
                let moisture = 0;
                let loss = 0;
                let efficiency = 0;
                let status = '未开始';
                let statusClass = 'bg-gray-100 text-gray-600';

                if (stepData) {
                    inputAmount = stepData.input || 0;
                    outputAmount = stepData.output || 0;
                    moisture = stepData.moisture || 0;
                    loss = stepData.loss || 0;
                    efficiency = stepData.efficiency || 0;
                    status = '已完成';
                    statusClass = 'bg-green-100 text-green-800';
                } else if (skippedSteps.has(i)) {
                    status = '已跳过';
                    statusClass = 'bg-purple-100 text-purple-800';
                }

                row.innerHTML = `
                    <td class="border border-gray-300 px-4 py-3 font-medium text-gray-800">${i}</td>
                    <td class="border border-gray-300 px-4 py-3 text-gray-700">${stepConfig.name}</td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-gray-700">${inputAmount.toFixed(2)}</td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-gray-700">${outputAmount.toFixed(2)}</td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-gray-700">${moisture.toFixed(1)}%</td>
                    <td class="border border-gray-300 px-4 py-3 text-right ${loss > 0 ? 'text-red-600 font-semibold' : 'text-gray-700'}">${loss.toFixed(2)}</td>
                    <td class="border border-gray-300 px-4 py-3 text-right text-gray-700">${efficiency.toFixed(1)}%</td>
                    <td class="border border-gray-300 px-4 py-3 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${status}</span>
                    </td>
                `;

                tbody.appendChild(row);
            }
        }

        // 计算总成本
        function calculateTotalCost() {
            totalCost = 0;
            
            // 累加各步骤成本
            for (let i = 1; i <= 16; i++) {
                const step = calculationData['step' + i];
                if (step) {
                    totalCost += step.energyCost || 0;
                    totalCost += step.enzymeCost || 0;
                    totalCost += step.refiningCost || 0;
                    totalCost += step.coolingCost || 0;
                    totalCost += step.testingCost || 0;
                    totalCost += step.packagingCost || 0;
                }
            }
        }

        // 保存进度
        function saveProgress() {
            if (document.getElementById('autoSaveProgress').checked) {
                const progress = {
                    calculationData,
                    currentStep,
                    skippedSteps: Array.from(skippedSteps),
                    calculationDirection,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('materialBalanceProgress', JSON.stringify(progress));
            }
        }

        // 加载进度
        function loadProgress() {
            const savedProgress = localStorage.getItem('materialBalanceProgress');
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    calculationData = progress.calculationData || {};
                    currentStep = progress.currentStep || 1;
                    skippedSteps = new Set(progress.skippedSteps || []);
                    calculationDirection = progress.calculationDirection || 'forward';
                    
                    // 恢复计算方向
                    setCalculationDirection(calculationDirection);
                    
                    // 更新步骤状态
                    for (let i = 1; i <= 16; i++) {
                        if (calculationData['step' + i]) {
                            updateStepStatus(i, 'completed');
                        } else if (skippedSteps.has(i)) {
                            updateStepStatus(i, 'skipped');
                        }
                    }
                    
                    // 启用当前步骤
                    enableStep(currentStep);
                    
                    showNotification('已加载上次进度', 'info');
                } catch (e) {
                    console.error('加载进度失败:', e);
                }
            }
        }

        // 保存设置
        function saveSettings() {
            const settings = {
                precision: document.getElementById('calculationPrecision').value,
                defaultMaterialAmount: document.getElementById('defaultMaterialAmount').value,
                defaultProductAmount: document.getElementById('defaultProductAmount').value,
                showAdvancedMetrics: document.getElementById('showAdvancedMetrics').checked,
                autoSaveProgress: document.getElementById('autoSaveProgress').checked
            };
            
            localStorage.setItem('materialBalanceSettings', JSON.stringify(settings));
            closeSettings();
            showNotification('设置保存成功', 'success');
        }

        // 加载设置
        function loadSavedSettings() {
            const savedSettings = localStorage.getItem('materialBalanceSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    if (document.getElementById('calculationPrecision')) {
                        document.getElementById('calculationPrecision').value = settings.precision || '0.01';
                    }
                    if (document.getElementById('defaultMaterialAmount')) {
                        document.getElementById('defaultMaterialAmount').value = settings.defaultMaterialAmount || '1000';
                    }
                    if (document.getElementById('defaultProductAmount')) {
                        document.getElementById('defaultProductAmount').value = settings.defaultProductAmount || '330';
                    }
                    if (document.getElementById('showAdvancedMetrics')) {
                        document.getElementById('showAdvancedMetrics').checked = settings.showAdvancedMetrics !== false;
                    }
                    if (document.getElementById('autoSaveProgress')) {
                        document.getElementById('autoSaveProgress').checked = settings.autoSaveProgress !== false;
                    }
                } catch (e) {
                    console.error('加载设置失败:', e);
                }
            }
        }

        // 显示设置
        function showSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        // 关闭设置
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const messageSpan = document.getElementById('notificationMessage');

            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${colors[type]}`;
            icon.className = `fa ${icons[type]} mr-2`;
            messageSpan.textContent = message;

            notification.classList.remove('translate-x-full');

            setTimeout(() => {
                notification.classList.add('translate-x-full');
            }, 3000);
        }

        // 事件监听器
        document.getElementById('resetAllBtn').addEventListener('click', function() {
            if (confirm('确定要重置所有数据吗？')) {
                resetAllSteps();
            }
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            if (Object.keys(calculationData).length === 0) {
                showNotification('请先完成计算', 'error');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                calculationDirection: calculationDirection,
                calculationData: calculationData,
                skippedSteps: Array.from(skippedSteps),
                summary: {
                    totalInput: calculationData.step1 ? calculationData.step1.input : 0,
                    finalOutput: calculationData.step16 ? calculationData.step16.output : 0,
                    totalLoss: calculationData.step1 && calculationData.step16 ? 
                              calculationData.step1.input - calculationData.step16.output : 0,
                    totalYield: calculationData.step1 && calculationData.step16 ? 
                              (calculationData.step16.output / calculationData.step1.input) * 100 : 0,
                    totalCost: totalCost
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `物料衡算结果_${calculationDirection}_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showNotification('结果导出成功', 'success');
        });

        document.getElementById('settingsBtn').addEventListener('click', showSettings);

        document.getElementById('settingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettings();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeSettings();
            }
        });
    </script>
    <!-- Footer -->
    <footer class="footer">
    由 Karcen Zheng 制作，<a href="https://karcen.github.io/zhengjiacheng.github.io/" target="_blank">联系我</a>
	</footer>
</body>

</html>
